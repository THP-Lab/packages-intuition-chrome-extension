FROM docker.io/node:lts-alpine as base

ARG PINATA_JWT_KEY
ARG PINATA_GATEWAY_KEY
ARG IPFS_GATEWAY
ARG PRIVATE_KEY
ARG PRIVATE_KEY_DEV
ARG ADDITIONAL_STAKE_ATOM
ARG ADDITIONAL_STAKE_TRIPLE
ARG CLOUDINARY_CLOUD_NAME
ARG CLOUDINARY_API_KEY
ARG CLOUDINARY_API_SECRET
ARG SUPABASE_URL
ARG SUPABASE_KEY
ARG VITE_DEPLOY_ENV
ARG VITE_ALCHEMY_API_KEY
ARG ALCHEMY_API_KEY
ARG VITE_ORIGIN_URL
ARG ORIGIN_URL
ARG PRIVY_APP_ID
ARG PRIVY_AUTH_URL
ARG PRIVY_APP_SECRET
ARG PRIVY_VERIFICATION_KEY

ENV PINATA_JWT_KEY=${PINATA_JWT_KEY}
ENV PINATA_GATEWAY_KEY=${PINATA_GATEWAY_KEY}
ENV IPFS_GATEWAY=${IPFS_GATEWAY}
ENV PRIVATE_KEY=${PRIVATE_KEY}
ENV PRIVATE_KEY_DEV=${PRIVATE_KEY_DEV}
ENV ADDITIONAL_STAKE_ATOM=${ADDITIONAL_STAKE_ATOM}
ENV ADDITIONAL_STAKE_TRIPLE=${ADDITIONAL_STAKE_TRIPLE}
ENV CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
ENV CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
ENV CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
ENV SUPABASE_URL=${SUPABASE_URL}
ENV SUPABASE_KEY=${SUPABASE_KEY}
ENV VITE_DEPLOY_ENV=${VITE_DEPLOY_ENV}
ENV VITE_ALCHEMY_API_KEY=${VITE_ALCHEMY_API_KEY}
ENV ALCHEMY_API_KEY=${ALCHEMY_API_KEY}
ENV VITE_ORIGIN_URL=${VITE_ORIGIN_URL}
ENV ORIGIN_URL=${ORIGIN_URL}
ENV PRIVY_APP_ID=${PRIVY_APP_ID}
ENV PRIVY_APP_SECRET=${PRIVY_APP_SECRET}
ENV PRIVY_AUTH_URL=${PRIVY_AUTH_URL}
ENV PRIVY_VERIFICATION_KEY=${PRIVY_VERIFICATION_KEY}

WORKDIR /app

# Copy things specifically needed for this app
COPY package.json \
    project.json \
	tsconfig* \
	nx.json \
	pnpm*.yaml \
    .eslintrc.base.cjs \
    .verdaccio \
	./
COPY apps/data-populator ./apps/data-populator
COPY packages ./packages

# Install necessary packages
RUN apk add --no-cache \
    python3 \
    make \
    gcc \
    g++

RUN npm install -g pnpm@9.0.6

# Build stage
FROM base as build

# Install nx globally
RUN npm install -g nx@latest

# Install dependencies
RUN pnpm install

# Build the data-populator app
RUN pnpm run data-populator:build

# Production stage
FROM base

# Copy built files from the build stage
COPY --from=build /app /app

# Set environment variables for NX
ENV NX_REJECT_UNKNOWN_LOCAL_CACHE=0
ENV PORT=8080
ENV HOST=0.0.0.0

# Expose the application port
EXPOSE 8080

# Start the application
CMD [ "pnpm", "run", "data-populator:start" ]
